AWSTemplateFormatVersion: 2010-09-09

Description: >-
    Creates the Preservation Services cluster of docker containers for the APTrust environments. These resources may be needed to scale frequently
    and be updated to be kept secure.

Parameters:

  DNS:
    Description: Staging private Namespace
    Type: String
    Default: staging
    AllowedValues:
      - staging
      - demo
      - prod

  FamTag:
    Description: Provides a family tag based on the environment for the family of each container/task definition; (p)rod, (s)taging, (d)emo.
    Type: String
    Default: s
    AllowedValues:
      - s
      - d
      - p

  ClusterName:
    Description: The Name of the Fargate cluster hosting Preservation Services.
    Type: String
    Default: ecs-preserv-staging
    AllowedValues:
      - ecs-preserv-staging
      - ecs-preserv-demo
      - ecs-preserv-prod

  MaxContainers:
    Description: Maximum number of containers desired for the scaling services.
    Type: Number
    AllowedValues: [1, 2, 3, 4, 5]
    Default: 3

  Envn:
    Description: The environment for the parameter store nomenclature.
    Type: String
    Default: STAGING
    AllowedValues:
        - STAGING
        - DEMO
        - PROD

  LogDays:
    Description: 'Sets the number of days for retaining logs. Can be set according to Cluster'
    Type: Number
    AllowedValues: [1, 7, 14, 30, 90]
    Default: 30 

Conditions:
  IsStaging: !Or [!Equals [!Ref DNS, 'staging'], !Equals [!Ref DNS, 'demo']]
  #IsPrimary: !Or [!Equals [!Ref DNS, 'prod'] , !Equals [!Ref DNS, 'demo']]
  IsPrimary: !Equals [!Ref DNS, 'prod']
Resources:

  Cluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Ref ClusterName
      CapacityProviders:
        - FARGATE
        - FARGATE_SPOT
      DefaultCapacityProviderStrategy:
        Fn::If:
          - IsPrimary
          - 
            - CapacityProvider: FARGATE
              Weight: 1
              Base: 1
            - CapacityProvider: FARGATE_SPOT
              Weight: 2 
          - 
            - CapacityProvider: FARGATE_SPOT
              Weight: 1
      ClusterSettings:
        - Name: containerInsights
          Value: enabled
      Configuration:
        ExecuteCommandConfiguration:
          Logging: OVERRIDE
          LogConfiguration:
            CloudWatchLogGroupName: !Sub '/ecs/${DNS}/registry'
      Tags:
      - Key: Name
        Value: !Sub 'ecs-preserv-${DNS}'
      - Key: Environment
        Value: !Ref DNS
      - Key: Service
        Value: preserv

  LogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Retain
    Properties:
      LogGroupName: !Sub '/ecs/${DNS}/preserv'
      RetentionInDays: !Ref 'LogDays'
      Tags:
        - Key: Environment
          Value: !Ref DNS
        - Key: Service
          Value: preserv

  AptdeleteService:
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      EnableExecuteCommand: true
    #  LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PublicSubnet0-${DNS}" 
          - Fn::ImportValue: !Sub "PublicSubnet1-${DNS}"
          #- Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          #- Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceName: ecs-delete
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - AptdeleteServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Service
        Value: preserv
      - Key: Environment
        Value: !Ref DNS
      TaskDefinition: !Ref AptdeleteTaskDefinition

  AptdeleteServiceDiscoveryEntry:
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"aptdelete" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: delete.preserv
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"


  AptdeleteTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref DNS
        Essential: false
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Aptdelete_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Aptdelete_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: !Sub 'arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY'
        - Name: LOG_DIR
          ValueFrom: !Sub 'arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/LOG_DIR'
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: !Sub 'arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_BUFFER_SIZE'
        - Name: APT_DELETE_WORKERS
          ValueFrom: !Sub 'arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_WORKERS'
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: !Sub 'arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_BUFFER_SIZE'
        - Name: APT_FIXITY_WORKERS
          ValueFrom: !Sub 'arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_WORKERS'
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub 'arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_BUFFER_SIZE'
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: !Sub 'arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_WORKERS'
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: !Sub 'arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_WORKERS'
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: !Sub 'arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_BUFFER_SIZE'
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: !Sub 'arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_WORKERS'
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: !Sub 'arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE'
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: !Sub 'arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS'
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/STAGING_BUCKET
        - Name: QUEUE_FIXITY_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/QUEUE_FIXITY_INTERVAL
        - Name: MAX_FIXITY_ITEMS_PER_RUN
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_FIXITY_ITEMS_PER_RUN
        - Name: APT_QUEUE_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_QUEUE_INTERVAL
        - Name: INGEST_BUCKET_READER_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_BUCKET_READER_INTERVAL
        Essential: true
        StopTimeout: 120
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/aptrust/apt_delete:27f650d-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: delete
        Name: delete
      Cpu: "256"
      TaskRoleArn:
        Fn::ImportValue: !Sub "FargateIAMRole-${DNS}"
      ExecutionRoleArn:
        Fn::ImportValue: !Sub "ECSServiceRole-${DNS}"
      Family: !Sub 'delete-${FamTag}'
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE

  AptfixityService:
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      EnableExecuteCommand: true
    #  LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          #- Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          #- Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
          - Fn::ImportValue: !Sub "PublicSubnet0-${DNS}" 
          - Fn::ImportValue: !Sub "PublicSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceName: ecs-fixity
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - AptfixityServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Service
        Value: preserv
      - Key: Environment
        Value: !Ref "DNS"
      TaskDefinition: !Ref AptfixityTaskDefinition


  AptfixityServiceDiscoveryEntry:
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"aptfixity" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: fixity.preserv
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"

  AptfixityTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Aptfixity_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Aptfixity_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/STAGING_BUCKET
        - Name: QUEUE_FIXITY_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/QUEUE_FIXITY_INTERVAL
        - Name: MAX_FIXITY_ITEMS_PER_RUN
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_FIXITY_ITEMS_PER_RUN
        - Name: APT_QUEUE_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_QUEUE_INTERVAL
        - Name: INGEST_BUCKET_READER_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_BUCKET_READER_INTERVAL
        Essential: true
        StopTimeout: 120
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/aptrust/apt_fixity:27f650d-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: fixity
        Name: fixity
      Cpu: "256"
      TaskRoleArn:
        Fn::ImportValue: !Sub "FargateIAMRole-${DNS}"
      ExecutionRoleArn:
        Fn::ImportValue: !Sub "ECSServiceRole-${DNS}"
      Family: !Sub 'aptfixity-${FamTag}'
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
      
  AptqueuefixityService:
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      EnableExecuteCommand: true
    #  LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
          #- Fn::ImportValue: !Sub "PublicSubnet0-${DNS}" 
          #- Fn::ImportValue: !Sub "PublicSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy:  REPLICA
      ServiceName: ecs-queuefixity
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - AptqueuefixityServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref AptqueuefixityTaskDefinition

  AptqueuefixityServiceDiscoveryEntry:
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"aptqueuefixity" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: queuefixity.preserv
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"


  AptqueuefixityTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Aptqueuefixity_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Aptqueuefixity_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/STAGING_BUCKET
        - Name: QUEUE_FIXITY_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/QUEUE_FIXITY_INTERVAL
        - Name: MAX_FIXITY_ITEMS_PER_RUN
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_FIXITY_ITEMS_PER_RUN
        - Name: APT_QUEUE_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_QUEUE_INTERVAL
        - Name: INGEST_BUCKET_READER_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_BUCKET_READER_INTERVAL
        Essential: true
        StopTimeout: 120
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/aptrust/apt_queue_fixity:27f650d-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: aptqueuefixity
        Name: queuefixity
      Cpu: "256"
      TaskRoleArn:
        Fn::ImportValue: !Sub "FargateIAMRole-${DNS}"
      ExecutionRoleArn:
        Fn::ImportValue: !Sub "ECSServiceRole-${DNS}"
      Family: !Sub 'queuefixity-${FamTag}'
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE

  BagrestorerService:
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      EnableExecuteCommand: true
    #  LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          #- Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          #- Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
          - Fn::ImportValue: !Sub "PublicSubnet0-${DNS}" 
          - Fn::ImportValue: !Sub "PublicSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceName: ecs-bagrestorer
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - BagrestorerServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref BagrestorerTaskDefinition

  BagrestorerServiceDiscoveryEntry:
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"bagrestorer" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: bagrestorer.preserv
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"

  BagrestorerTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Bagrestorer_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Bagrestorer_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/STAGING_BUCKET
        - Name: QUEUE_FIXITY_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/QUEUE_FIXITY_INTERVAL
        - Name: MAX_FIXITY_ITEMS_PER_RUN
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_FIXITY_ITEMS_PER_RUN
        - Name: APT_QUEUE_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_QUEUE_INTERVAL
        - Name: INGEST_BUCKET_READER_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_BUCKET_READER_INTERVAL
        Essential: true
        StopTimeout: 120
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/aptrust/bag_restorer:27f650d-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: bagrestorer
        Name: bagrestorer
      Cpu: "256"
      TaskRoleArn:
        Fn::ImportValue: !Sub "FargateIAMRole-${DNS}"
      ExecutionRoleArn:
        Fn::ImportValue: !Sub "ECSServiceRole-${DNS}"
      Family: !Sub 'bagrestorer-${FamTag}'
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE


  FilerestorerService:
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      EnableExecuteCommand: true
    #  LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          #- Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          #- Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
          - Fn::ImportValue: !Sub "PublicSubnet0-${DNS}" 
          - Fn::ImportValue: !Sub "PublicSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceName: ecs-filerestorer
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - FilerestorerServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref FilerestorerTaskDefinition

  FilerestorerServiceDiscoveryEntry:
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"filerestorer" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: filerestorer.preserv
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"

  FilerestorerTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Filerestorer_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Filerestorer_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/STAGING_BUCKET
        - Name: QUEUE_FIXITY_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/QUEUE_FIXITY_INTERVAL
        - Name: MAX_FIXITY_ITEMS_PER_RUN
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_FIXITY_ITEMS_PER_RUN
        - Name: APT_QUEUE_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_QUEUE_INTERVAL
        - Name: INGEST_BUCKET_READER_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_BUCKET_READER_INTERVAL
        Essential: true
        StopTimeout: 120
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/aptrust/file_restorer:27f650d-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: filerestorer
        Name: filerestorer
      Cpu: "256"
      TaskRoleArn:
        Fn::ImportValue: !Sub "FargateIAMRole-${DNS}"
      ExecutionRoleArn:
        Fn::ImportValue: !Sub "ECSServiceRole-${DNS}"
      Family: !Sub 'filerestorer-${FamTag}'
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE

  GlacierrestorerService:
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      EnableExecuteCommand: true
    #  LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          #- Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          #- Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
          - Fn::ImportValue: !Sub "PublicSubnet0-${DNS}" 
          - Fn::ImportValue: !Sub "PublicSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceName: ecs-glacierrestorer
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - GlacierrestorerServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref GlacierrestorerTaskDefinition

  GlacierrestorerServiceDiscoveryEntry:
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"glacierrestorer" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: glacierrestorer.preserv
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"


  GlacierrestorerTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Glacierrestorer_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Glacierrestorer_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/STAGING_BUCKET
        - Name: QUEUE_FIXITY_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/QUEUE_FIXITY_INTERVAL
        - Name: MAX_FIXITY_ITEMS_PER_RUN
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_FIXITY_ITEMS_PER_RUN
        - Name: APT_QUEUE_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_QUEUE_INTERVAL
        - Name: INGEST_BUCKET_READER_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_BUCKET_READER_INTERVAL
        Essential: true
        StopTimeout: 120
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/aptrust/glacier_restorer:27f650d-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: glacierrestorer
        Name: glacierrestorer
      Cpu: "256"
      TaskRoleArn:
        Fn::ImportValue: !Sub "FargateIAMRole-${DNS}"
      ExecutionRoleArn:
        Fn::ImportValue: !Sub "ECSServiceRole-${DNS}"
      Family: !Sub 'glacierrestorer-${FamTag}'
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE

  IngestbucketreaderService:
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      EnableExecuteCommand: true
    #  LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
          #- Fn::ImportValue: !Sub "PublicSubnet0-${DNS}" 
          #- Fn::ImportValue: !Sub "PublicSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceName: ecs-bucketreader
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - IngestbucketreaderServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref IngestbucketreaderTaskDefinition

  IngestbucketreaderServiceDiscoveryEntry:
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"ingestbucketreader" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: bucketreader.preserv
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"

  IngestbucketreaderTaskDefinition:
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Ingestbucketreader_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Ingestbucketreader_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/STAGING_BUCKET
        - Name: QUEUE_FIXITY_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/QUEUE_FIXITY_INTERVAL
        - Name: MAX_FIXITY_ITEMS_PER_RUN
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_FIXITY_ITEMS_PER_RUN
        - Name: APT_QUEUE_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_QUEUE_INTERVAL
        - Name: INGEST_BUCKET_READER_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_BUCKET_READER_INTERVAL
        Essential: true
        StopTimeout: 120
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/aptrust/ingest_bucket_reader:27f650d-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: bucketreader
        Name: bucketreader
      Cpu: "256"
      TaskRoleArn:
        Fn::ImportValue: !Sub "FargateIAMRole-${DNS}"
      ExecutionRoleArn:
        Fn::ImportValue: !Sub "ECSServiceRole-${DNS}"
      Family: !Sub 'bucketreader-${FamTag}'
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    Type: AWS::ECS::TaskDefinition

  IngestcleanupService:
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      EnableExecuteCommand: true
    #  LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
          #- Fn::ImportValue: !Sub "PublicSubnet0-${DNS}" 
          #- Fn::ImportValue: !Sub "PublicSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceName: ecs-cleanup
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - IngestcleanupServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition:
        Ref: IngestcleanupTaskDefinition

  IngestcleanupServiceDiscoveryEntry:
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"ingestcleanup" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: cleanup.preserv
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"


  IngestcleanupTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Ingestcleanup_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Ingestcleanup_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/STAGING_BUCKET
        - Name: QUEUE_FIXITY_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/QUEUE_FIXITY_INTERVAL
        - Name: MAX_FIXITY_ITEMS_PER_RUN
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_FIXITY_ITEMS_PER_RUN
        - Name: APT_QUEUE_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_QUEUE_INTERVAL
        - Name: INGEST_BUCKET_READER_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_BUCKET_READER_INTERVAL
        Essential: true
        StopTimeout: 120
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/aptrust/ingest_cleanup:27f650d-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: ingestcleanup
        Name: cleanup
      Cpu: "256"
      TaskRoleArn:
        Fn::ImportValue: !Sub "FargateIAMRole-${DNS}"
      ExecutionRoleArn:
        Fn::ImportValue: !Sub "ECSServiceRole-${DNS}"
      Family: !Sub 'cleanup-${FamTag}'
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE


  erService:
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      EnableExecuteCommand: true
    #  LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
          #- Fn::ImportValue: !Sub "PublicSubnet0-${DNS}" 
          #- Fn::ImportValue: !Sub "PublicSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceName: ecs-formatidentifier
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - erServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref erTaskDefinition


  erServiceDiscoveryEntry:
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"ingestformatidentifier" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: formatidentifier.preserv
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"


  erTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: er_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: er_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/STAGING_BUCKET
        - Name: QUEUE_FIXITY_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/QUEUE_FIXITY_INTERVAL
        - Name: MAX_FIXITY_ITEMS_PER_RUN
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_FIXITY_ITEMS_PER_RUN
        - Name: APT_QUEUE_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_QUEUE_INTERVAL
        - Name: INGEST_BUCKET_READER_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_BUCKET_READER_INTERVAL
        Essential: true
        StopTimeout: 120
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/aptrust/ingest_format_identifier:27f650d-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: ingestformatidentifier
        Name: formatidentifier
      Cpu: "256"
      TaskRoleArn:
        Fn::ImportValue: !Sub "FargateIAMRole-${DNS}"
      ExecutionRoleArn:
        Fn::ImportValue: !Sub "ECSServiceRole-${DNS}"
      Family: !Sub 'formatidentifier-${FamTag}'
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE


  IngestprefetchService:
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      EnableExecuteCommand: true
    #  LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
          #- Fn::ImportValue: !Sub "PublicSubnet0-${DNS}" 
          #- Fn::ImportValue: !Sub "PublicSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceName: ecs-prefetch
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - IngestprefetchServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref IngestprefetchTaskDefinition


  IngestprefetchServiceDiscoveryEntry:
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"ingestprefetch" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: prefetch.preserv
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"


  IngestprefetchTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Ingestprefetch_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Ingestprefetch_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/STAGING_BUCKET
        - Name: QUEUE_FIXITY_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/QUEUE_FIXITY_INTERVAL
        - Name: MAX_FIXITY_ITEMS_PER_RUN
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_FIXITY_ITEMS_PER_RUN
        - Name: APT_QUEUE_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_QUEUE_INTERVAL
        - Name: INGEST_BUCKET_READER_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_BUCKET_READER_INTERVAL
        Essential: true
        StopTimeout: 120
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/aptrust/ingest_pre_fetch:27f650d-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: prefetch
        Name: prefetch
      Cpu: "512"
      TaskRoleArn:
        Fn::ImportValue: !Sub "FargateIAMRole-${DNS}"
      ExecutionRoleArn:
        Fn::ImportValue: !Sub "ECSServiceRole-${DNS}"
      Family: !Sub 'prefetch-${FamTag}'
      Memory: "1024"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE



  IngestpreservationuploaderService:
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      EnableExecuteCommand: true
    #  LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          #- Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          #- Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
          - Fn::ImportValue: !Sub "PublicSubnet0-${DNS}" 
          - Fn::ImportValue: !Sub "PublicSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceName: ecs-uploader
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - IngestpreservationuploaderServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref IngestpreservationuploaderTaskDefinition


  IngestpreservationuploaderServiceDiscoveryEntry:
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"ingestpreservationuploader" service discovery entry in Cloud
        Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: uploader.preserv
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"


  IngestpreservationuploaderTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Ingestpreservationuploader_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Ingestpreservationuploader_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/STAGING_BUCKET
        - Name: QUEUE_FIXITY_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/QUEUE_FIXITY_INTERVAL
        - Name: MAX_FIXITY_ITEMS_PER_RUN
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_FIXITY_ITEMS_PER_RUN
        - Name: APT_QUEUE_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_QUEUE_INTERVAL
        - Name: INGEST_BUCKET_READER_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_BUCKET_READER_INTERVAL
        Essential: true
        StopTimeout: 120
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/aptrust/ingest_preservation_uploader:27f650d-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: ingestuploader
        Name: uploader
      Cpu: "512"
      TaskRoleArn:
        Fn::ImportValue: !Sub "FargateIAMRole-${DNS}"
      ExecutionRoleArn:
        Fn::ImportValue: !Sub "ECSServiceRole-${DNS}"
      Family: !Sub 'uploader-${FamTag}'
      Memory: "1024"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE

  IngestpreservationverifierService:
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      EnableExecuteCommand: true
    #  LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          #- Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          #- Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
          - Fn::ImportValue: !Sub "PublicSubnet0-${DNS}" 
          - Fn::ImportValue: !Sub "PublicSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceName: ecs-verifier
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - IngestpreservationverifierServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref IngestpreservationverifierTaskDefinition


  IngestpreservationverifierServiceDiscoveryEntry:
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"ingestpreservationverifier" service discovery entry in Cloud
        Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: verifier.preserv
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"


  IngestpreservationverifierTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Ingestpreservationverifier_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Ingestpreservationverifier_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/STAGING_BUCKET
        - Name: QUEUE_FIXITY_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/QUEUE_FIXITY_INTERVAL
        - Name: MAX_FIXITY_ITEMS_PER_RUN
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_FIXITY_ITEMS_PER_RUN
        - Name: APT_QUEUE_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_QUEUE_INTERVAL
        - Name: INGEST_BUCKET_READER_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_BUCKET_READER_INTERVAL
        Essential: true
        StopTimeout: 120
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/aptrust/ingest_preservation_verifier:27f650d-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: ingestverifier
        Name: verifier
      Cpu: "256"
      TaskRoleArn:
        Fn::ImportValue: !Sub "FargateIAMRole-${DNS}"
      ExecutionRoleArn:
        Fn::ImportValue: !Sub "ECSServiceRole-${DNS}"
      Family: !Sub 'verifier-${FamTag}'
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE

  IngestrecorderService:
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      EnableExecuteCommand: true
    #  LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
          #- Fn::ImportValue: !Sub "PublicSubnet0-${DNS}" 
          #- Fn::ImportValue: !Sub "PublicSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceName: ecs-recorder
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - IngestrecorderServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref IngestrecorderTaskDefinition


  IngestrecorderServiceDiscoveryEntry:
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"ingestrecorder" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: recorder.preserv
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"


  IngestrecorderTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Ingestrecorder_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Ingestrecorder_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/STAGING_BUCKET
        - Name: QUEUE_FIXITY_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/QUEUE_FIXITY_INTERVAL
        - Name: MAX_FIXITY_ITEMS_PER_RUN
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_FIXITY_ITEMS_PER_RUN
        - Name: APT_QUEUE_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_QUEUE_INTERVAL
        - Name: INGEST_BUCKET_READER_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_BUCKET_READER_INTERVAL
        Essential: true
        StopTimeout: 120
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/aptrust/ingest_recorder:27f650d-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: ingestrecorder
        Name: recorder
      Cpu: "256"
      TaskRoleArn:
        Fn::ImportValue: !Sub "FargateIAMRole-${DNS}"
      ExecutionRoleArn:
        Fn::ImportValue: !Sub "ECSServiceRole-${DNS}"
      Family: !Sub 'recorder-${FamTag}'
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE



  IngeststaginguploaderService:
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 2
      EnableExecuteCommand: true
    #  LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
          #- Fn::ImportValue: !Sub "PublicSubnet0-${DNS}" 
          #- Fn::ImportValue: !Sub "PublicSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceName: ecs-staginguploader
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - IngeststaginguploaderServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref IngeststaginguploaderTaskDefinition


  IngeststaginguploaderServiceDiscoveryEntry:
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"ingeststaginguploader" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: staginguploader.preserv
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"


  IngeststaginguploaderTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Ingeststaginguploader_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Ingeststaginguploader_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/STAGING_BUCKET
        - Name: QUEUE_FIXITY_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/QUEUE_FIXITY_INTERVAL
        - Name: MAX_FIXITY_ITEMS_PER_RUN
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_FIXITY_ITEMS_PER_RUN
        - Name: APT_QUEUE_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_QUEUE_INTERVAL
        - Name: INGEST_BUCKET_READER_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_BUCKET_READER_INTERVAL
        Essential: true
        StopTimeout: 120
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/aptrust/ingest_staging_uploader:27f650d-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: staginguploader
        Name: staginguploader
      Cpu: "512"
      TaskRoleArn:
        Fn::ImportValue: !Sub "FargateIAMRole-${DNS}"
      ExecutionRoleArn:
        Fn::ImportValue: !Sub "ECSServiceRole-${DNS}"
      Family: !Sub 'staginguploader-${FamTag}'
      Memory: "1024"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE



  IngestvalidatorService:
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      EnableExecuteCommand: true
    #  LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
          #- Fn::ImportValue: !Sub "PublicSubnet0-${DNS}" 
          #- Fn::ImportValue: !Sub "PublicSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceName: ecs-validator
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - IngestvalidatorServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref IngestvalidatorTaskDefinition

  IngestvalidatorServiceDiscoveryEntry:
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"ingestvalidator" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: validator.preserv
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"

  IngestvalidatorTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Ingestvalidator_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Ingestvalidator_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/STAGING_BUCKET
        - Name: QUEUE_FIXITY_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/QUEUE_FIXITY_INTERVAL
        - Name: MAX_FIXITY_ITEMS_PER_RUN
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_FIXITY_ITEMS_PER_RUN
        - Name: APT_QUEUE_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_QUEUE_INTERVAL
        - Name: INGEST_BUCKET_READER_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_BUCKET_READER_INTERVAL
        Essential: true
        StopTimeout: 120
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/aptrust/ingest_validator:27f650d-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: ingestvalidator
        Name: validator
      Cpu: "256"
      TaskRoleArn:
        Fn::ImportValue: !Sub "FargateIAMRole-${DNS}"
      ExecutionRoleArn:
        Fn::ImportValue: !Sub "ECSServiceRole-${DNS}"
      Family: !Sub 'validator-${FamTag}'
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE


  ReingestmanagerService:
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      EnableExecuteCommand: true
    #  LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
          #- Fn::ImportValue: !Sub "PublicSubnet0-${DNS}" 
          #- Fn::ImportValue: !Sub "PublicSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceName: ecs-reingestmanager
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - ReingestmanagerServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref ReingestmanagerTaskDefinition


  ReingestmanagerServiceDiscoveryEntry:
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"reingestmanager" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: reingestmanager.preserv
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"


  ReingestmanagerTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Reingestmanager_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Reingestmanager_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/STAGING_BUCKET
        - Name: QUEUE_FIXITY_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/QUEUE_FIXITY_INTERVAL
        - Name: MAX_FIXITY_ITEMS_PER_RUN
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/MAX_FIXITY_ITEMS_PER_RUN
        - Name: APT_QUEUE_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/APT_QUEUE_INTERVAL
        - Name: INGEST_BUCKET_READER_INTERVAL
          ValueFrom: !Sub arn:aws:ssm:us-east-1:997427182289:parameter/${Envn}/PRESERV/INGEST_BUCKET_READER_INTERVAL
        Essential: true
        StopTimeout: 120
        Image: 997427182289.dkr.ecr.us-east-1.amazonaws.com/docker-hub/aptrust/reingest_manager:27f650d-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: reingestmanager
        Name: reingestmanager
      Cpu: "256"
      TaskRoleArn:
        Fn::ImportValue: !Sub "FargateIAMRole-${DNS}"
      ExecutionRoleArn:
        Fn::ImportValue: !Sub "ECSServiceRole-${DNS}"
      Family: !Sub 'reingestmanager-${FamTag}'
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE

  #Scaling and Alarms for Preserv-Services

  #AutoScalingStagingUpLoadTarget:
  #  Type: AWS::ApplicationAutoScaling::ScalableTarget
  #  Properties:
  #    MinCapacity: 1
  #    MaxCapacity: !Ref MaxContainers
  #    ResourceId: !Join
  #      - '/'
  #      - - service
  #        - !Ref Cluster
  #        - !GetAtt IngeststaginguploaderService.Name
  #    ScalableDimension: ecs:service:DesiredCount
  #    ServiceNamespace: ecs
  #    RoleARN:
  #      Fn::ImportValue: !Sub "AutoScalingRole-${DNS}"

  #ScaleStagingUpPolicy:
  #  Type: AWS::ApplicationAutoScaling::ScalingPolicy
  #  Properties:
  #    PolicyName: !Sub '${IngeststaginguploaderService}MemoryScaleUpPolicy'
  #    PolicyType: StepScaling
  #    ScalingTargetId: !Ref AutoScalingStagingUpLoadTarget
  #    StepScalingPolicyConfiguration:
  #      AdjustmentType: ChangeInCapacity
  #      Cooldown: 120
  #      MetricAggregationType: Average
  #      StepAdjustments:
  #        - MetricIntervalLowerBound: 0
  #          MetricIntervalUpperBound: 650
  #          ScalingAdjustment: 1
  #        - MetricIntervalLowerBound: 650
  #          #MetricIntervalUpperBound: 1200
  #          ScalingAdjustment: 2

  #ScaleDownStagingUpPolicy:
  #  Type: AWS::ApplicationAutoScaling::ScalingPolicy
  #  Properties:
  #    PolicyName: !Sub '${IngeststaginguploaderService}MemoryScaleDownPolicy'
  #    PolicyType: StepScaling
  #    ScalingTargetId: !Ref AutoScalingStagingUpLoadTarget
  #    StepScalingPolicyConfiguration:
  #      AdjustmentType: ChangeInCapacity
  #      Cooldown: 200
  #      MetricAggregationType: Average
  #      StepAdjustments:
  #        - MetricIntervalUpperBound: 0
  #          ScalingAdjustment: -1

  #AlarmHighMemoryStagingUploader:
  #  Type: AWS::CloudWatch::Alarm
  #  Properties:
  #    ActionsEnabled: TRUE
  #    AlarmActions:
  #      - !Ref ScaleStagingUpPolicy
  #    AlarmDescription: 'Scale Up Alarm based on memory usage for ecs-staginguploader'
  #    ComparisonOperator: GreaterThanThreshold
  #    DatapointsToAlarm: 2
  #    # the dimensions can be found in the console after selecting a namespace to filter by
  #    Dimensions:
  #      - Name: ClusterName
  #        Value: !Sub "ecs-preserv-${DNS}"
  #      - Name: ServiceName
  #        Value: ecs-staginguploader
  #    EvaluationPeriods: 3
  #    # the metric name can be found in the console on the screen before a metric is graphed
  #    MetricName: MemoryUtilized
  #    # the namespace can be found in the console on the first screen before filtering metrics
  #    Namespace: ECS/ContainerInsights
  #    OKActions:
  #      - !Ref ScaleDownStagingUpPolicy
  #    Statistic: Sum
  #    Period: 60
  #    Threshold: 350
  #    TreatMissingData: ignore

  #ScaleStagingUpCPUPolicy:
  #  Type: AWS::ApplicationAutoScaling::ScalingPolicy
  #  Properties:
  #    PolicyName: !Sub '##${IngeststaginguploaderService}CPUScaleUpPolicy'
  #    PolicyType: StepScaling
  #    ScalingTargetId: !Ref AutoScalingStagingUpLoadTarget
  #    StepScalingPolicyConfiguration:
  #      AdjustmentType: ChangeInCapacity
  #      Cooldown: 120
  #      MetricAggregationType: Average
  #      StepAdjustments:
  #        - MetricIntervalLowerBound: 0
  #          MetricIntervalUpperBound: 650
  #          ScalingAdjustment: 1
  #        - MetricIntervalLowerBound: 650
  #          #MetricIntervalUpperBound: 1200
  #          ScalingAdjustment: 2
            
  
  #ScaleDownStagingCPUPolicy:
  #  Type: AWS::ApplicationAutoScaling::ScalingPolicy
  #  Properties:
  #    PolicyName: !Sub '${IngeststaginguploaderService}CPUScaleDownPolicy'
  #    PolicyType: StepScaling
  #    ScalingTargetId: !Ref AutoScalingStagingUpLoadTarget
  #    StepScalingPolicyConfiguration:
  #      AdjustmentType: ChangeInCapacity
  #      Cooldown: 200
  #      MetricAggregationType: Average
  #      StepAdjustments:
  #        - MetricIntervalLowerBound: 0
  #          ScalingAdjustment: -1
  
  #AlarmHighCPUStagingUploader:
  #  Type: AWS::CloudWatch::Alarm
  #  Properties:
  #    ActionsEnabled: TRUE
  #    AlarmActions:
  #      - !Ref ScaleStagingUpCPUPolicy
  #    AlarmDescription: 'Scaling alarm based on cpu usage for ecs-prefetch'
  #    ComparisonOperator: GreaterThanThreshold
  #    DatapointsToAlarm: 2
  #    # the dimensions can be found in the console after selecting a namespace to filter by
  #    Dimensions:
  #      - Name: ClusterName
  #        Value: !Sub "ecs-preserv-${DNS}"
  #      - Name: ServiceName
  #        Value: ecs-staginguploader
  #    EvaluationPeriods: 3
  #    # the metric name can be found in the console on the screen before a metric is graphed
  #    MetricName: CpuUtilized
  #    # the namespace can be found in the console on the first screen before filtering metrics
  #    Namespace: ECS/ContainerInsights
  #    OKActions:
  #      - !Ref ScaleDownStagingCPUPolicy
  #    Statistic: Sum
  #    Period: 60
  #    Threshold: 70
  #    TreatMissingData: ignore
  
  AutoScalingPrefetchTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    Properties:
      MinCapacity: 1
      MaxCapacity: !Ref MaxContainers
      ResourceId: !Join
        - '/'
        - - service
          - !Ref Cluster
          - !GetAtt IngestprefetchService.Name
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs
      RoleARN:
        Fn::ImportValue: !Sub "AutoScalingRole-${DNS}"

  ScaleUpPrefetchPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub '${IngestprefetchService}CPUScaleUpPolicy'
      PolicyType: StepScaling
      ScalingTargetId: !Ref AutoScalingPrefetchTarget
      StepScalingPolicyConfiguration:
        AdjustmentType: ChangeInCapacity
        Cooldown: 120
        MetricAggregationType: Average
        StepAdjustments:
          - MetricIntervalLowerBound: 0
            MetricIntervalUpperBound: 650
            ScalingAdjustment: 1
          - MetricIntervalLowerBound: 650
            #MetricIntervalUpperBound: 1200
            ScalingAdjustment: 2
            

  ScaleDownPrefetchPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub '${IngestprefetchService}CPUScaleDownPolicy'
      PolicyType: StepScaling
      ScalingTargetId: !Ref AutoScalingPrefetchTarget
      StepScalingPolicyConfiguration:
        AdjustmentType: ChangeInCapacity
        Cooldown: 200
        MetricAggregationType: Average
        StepAdjustments:
          - MetricIntervalUpperBound: 0
            ScalingAdjustment: -1

  AlarmHighCPUPrefetch:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: TRUE
      AlarmActions:
        - !Ref ScaleUpPrefetchPolicy
      AlarmDescription: 'Scaling alarm based on cpu usage for ecs-prefetch'
      ComparisonOperator: GreaterThanThreshold
      DatapointsToAlarm: 2
      # the dimensions can be found in the console after selecting a namespace to filter by
      Dimensions:
        - Name: ClusterName
          Value: !Sub "ecs-preserv-${DNS}"
        - Name: ServiceName
          Value: ecs-prefetch
      EvaluationPeriods: 3
      # the metric name can be found in the console on the screen before a metric is graphed
      MetricName: CpuUtilized
      # the namespace can be found in the console on the first screen before filtering metrics
      Namespace: ECS/ContainerInsights
      OKActions:
        - !Ref ScaleDownPrefetchPolicy
      Statistic: Sum
      Period: 60
      Threshold: 70
      TreatMissingData: ignore


  AutoScalingFormatIdTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    Properties:
      MinCapacity: 1
      MaxCapacity: !Ref MaxContainers
      ResourceId: !Join
        - '/'
        - - service
          - !Ref Cluster
          - !GetAtt erService.Name
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs
      RoleARN:
        Fn::ImportValue: !Sub "AutoScalingRole-${DNS}"

  ScaleUpFormatIdPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub '${erService}MemoryScaleUpPolicy'
      PolicyType: StepScaling
      ScalingTargetId: !Ref AutoScalingFormatIdTarget
      StepScalingPolicyConfiguration:
        AdjustmentType: ChangeInCapacity
        Cooldown: 120
        MetricAggregationType: Average
        StepAdjustments:
          - MetricIntervalLowerBound: 0
            MetricIntervalUpperBound: 350
            ScalingAdjustment: 1
          - MetricIntervalLowerBound: 350
            #MetricIntervalUpperBound: 1200
            ScalingAdjustment: 2  

  ScaleDownFormatIdPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub '${erService}MemoryScaleDownPolicy'
      PolicyType: StepScaling
      ScalingTargetId: !Ref AutoScalingFormatIdTarget
      StepScalingPolicyConfiguration:
        AdjustmentType: ChangeInCapacity
        Cooldown: 120
        MetricAggregationType: Average
        StepAdjustments:
          - MetricIntervalUpperBound: 0
            ScalingAdjustment: -1

  AlarmHighMemoryFormatId:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: TRUE
      AlarmActions:
        - !Ref ScaleUpFormatIdPolicy
      AlarmDescription: 'Scaling alarm based on memory usage for ecs-formatidentifier'
      ComparisonOperator: GreaterThanThreshold
      DatapointsToAlarm: 1
      # the dimensions can be found in the console after selecting a namespace to filter by
      Dimensions:
        - Name: ClusterName
          Value: !Sub "ecs-preserv-${DNS}"
        - Name: ServiceName
          Value: ecs-formatidentifier
      EvaluationPeriods: 3
      # the metric name can be found in the console on the screen before a metric is graphed
      MetricName: MemoryUtilized
      # the namespace can be found in the console on the first screen before filtering metrics
      Namespace: ECS/ContainerInsights
      OKActions:
        - !Ref ScaleDownFormatIdPolicy
      Statistic: Sum
      Period: 60
      Threshold: 300
      TreatMissingData: ignore

  AutoScalingPreservUploadTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    Properties:
      MinCapacity: 1
      MaxCapacity: !Ref MaxContainers
      ResourceId: !Join
        - '/'
        - - service
          - !Ref Cluster
          - !GetAtt IngestpreservationuploaderService.Name
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs
      RoleARN:
        Fn::ImportValue: !Sub "AutoScalingRole-${DNS}"

  ScaleUpPreservUploadPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub '${IngestpreservationuploaderService}MemoryScaleUpPolicy'
      PolicyType: StepScaling
      ScalingTargetId: !Ref AutoScalingPreservUploadTarget
      StepScalingPolicyConfiguration:
        AdjustmentType: ChangeInCapacity
        Cooldown: 120
        MetricAggregationType: Average
        StepAdjustments:
          - MetricIntervalLowerBound: 0
            MetricIntervalUpperBound: 650
            ScalingAdjustment: 1
          - MetricIntervalLowerBound: 650
            #MetricIntervalUpperBound: 1200
            ScalingAdjustment: 2
            

  ScaleDownPreservUploadPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub '${IngestpreservationuploaderService}MemoryScaleDownPolicy'
      PolicyType: StepScaling
      ScalingTargetId: !Ref AutoScalingPreservUploadTarget
      StepScalingPolicyConfiguration:
        AdjustmentType: ChangeInCapacity
        Cooldown: 120
        MetricAggregationType: Average
        StepAdjustments:
          - MetricIntervalUpperBound: 0
            ScalingAdjustment: -1 

  ScaleUpPreservUploadCPUPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub '{IngestpreservationuploaderService}CPUScaleUpPolicy'
      PolicyType: StepScaling
      ScalingTargetId: !Ref AutoScalingPreservUploadTarget
      StepScalingPolicyConfiguration:
        AdjustmentType: ChangeInCapacity
        Cooldown: 120
        MetricAggregationType: Average
        StepAdjustments:
          - MetricIntervalLowerBound: 0
            MetricIntervalUpperBound: 650
            ScalingAdjustment: 1
          - MetricIntervalLowerBound: 650
            #MetricIntervalUpperBound: 1200
            ScalingAdjustment: 2
  
  ScaleDownPreservUploadCPUPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub '${IngestpreservationuploaderService}CPUScaleDownPolicy'
      PolicyType: StepScaling
      ScalingTargetId: !Ref AutoScalingPreservUploadTarget
      StepScalingPolicyConfiguration:
        AdjustmentType: ChangeInCapacity
        Cooldown: 200
        MetricAggregationType: Average
        StepAdjustments:
          - MetricIntervalLowerBound: 0
            ScalingAdjustment: -1


  AlarmHighMemoryPreservUpload:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: TRUE
      AlarmActions:
        - !Ref ScaleUpPreservUploadPolicy
      AlarmDescription: 'Scaling alarm based on memory usage for ecs-upload'
      ComparisonOperator: GreaterThanThreshold
      DatapointsToAlarm: 2
      # the dimensions can be found in the console after selecting a namespace to filter by
      Dimensions:
        - Name: ClusterName
          Value: !Sub "ecs-preserv-${DNS}"
        - Name: ServiceName
          Value: ecs-uploader
      EvaluationPeriods: 3
      # the metric name can be found in the console on the screen before a metric is graphed
      MetricName: MemoryUtilized
      # the namespace can be found in the console on the first screen before filtering metrics
      Namespace: ECS/ContainerInsights
      OKActions:
        - !Ref ScaleDownPreservUploadPolicy
      Statistic: Sum
      Period: 60
      Threshold: 350
      TreatMissingData: ignore
  

  AlarmHighCPUPreservUploader:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: TRUE
      AlarmActions:
        - !Ref ScaleUpPreservUploadCPUPolicy
      AlarmDescription: 'Scaling alarm based on cpu usage for ecs-uploader'
      ComparisonOperator: GreaterThanThreshold
      DatapointsToAlarm: 2
      # the dimensions can be found in the console after selecting a namespace to filter by
      Dimensions:
        - Name: ClusterName
          Value: !Sub "ecs-preserv-${DNS}"
        - Name: ServiceName
          Value: ecs-uploader
      EvaluationPeriods: 3
      # the metric name can be found in the console on the screen before a metric is graphed
      MetricName: CpuUtilized
      # the namespace can be found in the console on the first screen before filtering metrics
      Namespace: ECS/ContainerInsights
      OKActions:
        - !Ref ScaleDownPreservUploadCPUPolicy
      Statistic: Sum
      Period: 60
      Threshold: 70
      TreatMissingData: ignore


  AutoScalingFixityTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    Properties:
      MinCapacity: 1
      MaxCapacity: !Ref MaxContainers
      ResourceId: !Join
        - '/'
        - - service
          - !Ref Cluster
          - !GetAtt AptfixityService.Name
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs
      RoleARN:
       Fn::ImportValue: !Sub "AutoScalingRole-${DNS}"

  ScaleUpFixityPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub '${AptfixityService}ScaleUpPolicy'
      PolicyType: StepScaling
      ScalingTargetId: !Ref AutoScalingFixityTarget
      StepScalingPolicyConfiguration:
        AdjustmentType: ChangeInCapacity
        Cooldown: 120
        MetricAggregationType: Average
        StepAdjustments:
          - MetricIntervalLowerBound: 0
            MetricIntervalUpperBound: 400
            ScalingAdjustment: 1
          - MetricIntervalLowerBound: 400
            #MetricIntervalUpperBound: 1200
            ScalingAdjustment: 2  

  ScaleDownFixityPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub '${AptfixityService}ScaleDownPolicy'
      PolicyType: StepScaling
      ScalingTargetId: !Ref AutoScalingFixityTarget
      StepScalingPolicyConfiguration:
        AdjustmentType: ChangeInCapacity
        Cooldown: 120
        MetricAggregationType: Average
        StepAdjustments:
          - MetricIntervalUpperBound: 0
            ScalingAdjustment: -1

  AlarmHighCPUFixity:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: TRUE
      AlarmActions:
        - !Ref ScaleUpFixityPolicy
      AlarmDescription: 'Scaling alarm based on cpu usage for ecs-fixity'
      ComparisonOperator: GreaterThanThreshold
      DatapointsToAlarm: 2
      # the dimensions can be found in the console after selecting a namespace to filter by
      Dimensions:
        - Name: ClusterName
          Value: !Sub "ecs-preserv-${DNS}"
        - Name: ServiceName
          Value: ecs-fixity
      EvaluationPeriods: 3
      # the metric name can be found in the console on the screen before a metric is graphed
      MetricName: CpuUtilized
      # the namespace can be found in the console on the first screen before filtering metrics
      Namespace: ECS/ContainerInsights
      OKActions:
        - !Ref ScaleDownFixityPolicy
      Statistic: Sum
      Period: 60
      Threshold: 70
      TreatMissingData: ignore
