AWSTemplateFormatVersion: 2010-09-09



Parameters:
  
  DNS:
    Description: Staging private Namespace
    Type: String
    Default: staging
  
  VPCID: 
    Description: Staging private Namespace
    Type: String
    Default: vpc-apt-staging
  
  ClusterName: 
    Description: The Name of the Fargate cluster hosting Preservation Services.
    Type: String
    Default: ecs-preserv-staging


Resources:

  PreservCapacityProviderAssociation:
    Type: AWS::ECS::ClusterCapacityProviderAssociations
    Properties: 
      CapacityProviders: 
        - FARGATE
        - FARGATE_SPOT 
      Cluster: !Ref Cluster
      DefaultCapacityProviderStrategy: 
        - CapacityProvider: FARGATE 
          Weight: 1
          Base: 1 
        - CapacityProvider: FARGATE_SPOT 
          Weight: 1 
          Base: 0
  
  Cluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Ref ClusterName
      ClusterSettings: 
        - Name: containerInsights
          Value: enabled 
      Configuration: 
        ExecuteCommandConfiguration: 
          Logging: DEFAULT 
      Tags:
      - Key: Name
        Value: !Sub 'ecs-preserv-${DNS}'
      - Key: Environment
        Value: !Ref DNS
      - Key: Service 
        Value: preserv

  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /ecs/preserv

  AptdeleteService: 
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA 
      ServiceName: ecs-aptdelete
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - AptdeleteServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: service
        Value: preserv
      - Key: Environment
        Value: !Ref DNS
      TaskDefinition:
        Ref: AptdeleteTaskDefinition
    
  AptdeleteServiceDiscoveryEntry: 
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"apt_delete" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: aptdelete
      NamespaceId: 
        Fn::ImportValue: !Sub "NameSpace-${DNS}"
    
  
  AptdeleteTaskDefinition: 
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref DNS
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Aptdelete_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Aptdelete_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/apt_delete:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: aptdelete
        Name: aptdelete
      Cpu: "256"
      ExecutionRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      TaskRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      Family: aptdelete
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    
  AptfixityService: 
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED 
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceName: aptfixity
      ServiceRegistries:   
      - RegistryArn:
          Fn::GetAtt:
          - AptfixityServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: service
        Value: preserv
      - Key: Environment
        Value: !Ref "DNS"
      TaskDefinition: !Ref AptfixityTaskDefinition
    
  
  AptfixityServiceDiscoveryEntry: 
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"apt_fixity" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: aptfixity
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"
    
  AptfixityTaskDefinition: 
    Type: AWS::ECS::TaskDefiniton
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Aptfixity_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Aptfixity_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/apt_fixity:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: aptfixity
        Name: aptfixity
      Cpu: "256"
      ExecutionRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      TaskRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      Family: preservation-services-apt_fixity
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    
  
  AptqueueService: 
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA 
      ServiceName: ecs-aptqueue
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - AptqueueServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Service
        Value: preserv
      - Key: Environment
        Value: !Ref "DNS"
      TaskDefinition:
        Ref: AptqueueTaskDefinition
  
  AptqueueServiceDiscoveryEntry: 
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"apt_queue" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: aptqueue
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"
    
  
  AptqueueTaskDefinition: 
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: side
        Name: Aptqueue_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Aptqueue_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/apt_queue:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: aptqueue
        Name: aptqueue
      Cpu: "256"
      ExecutionRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      TaskRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      Family: preservation-services-apt_queue
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    
  AptqueueTaskExecutionRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRole
          Condition: {}
          Effect: Allow
          Principal:
            Service: ecs-tasks.amazonaws.com
        Version: 2012-10-17
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
      - arn:aws:iam::aws:policy/AmazonSSMReadOnlyAccess
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: apt_queue
    Type: AWS::IAM::Role
  AptqueuefixityService:
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Ref: DefaultNetwork
          Subnets:
          - subnet-316bbe78
          - subnet-a53ee38b
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - AptqueuefixityServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: apt_queue_fixity
      TaskDefinition:
        Ref: AptqueuefixityTaskDefinition
    Type: AWS::ECS::Service
  AptqueuefixityServiceDiscoveryEntry:
    Properties:
      Description: '"apt_queue_fixity" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: apt_queue_fixity
      NamespaceId:
        Ref: CloudMap
    Type: AWS::ServiceDiscovery::Service
  AptqueuefixityTaskDefinition:
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - preservation-services
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:1.0
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: Aptqueuefixity_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Aptqueuefixity_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/apt_queue_fixity:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: apt_queue_fixity
      Cpu: "256"
      ExecutionRoleArn: !GetAtt AptqueuefixityTaskExecutionRole.Arn
      Family: preservation-services-apt_queue_fixity
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    Type: AWS::ECS::TaskDefinition
  AptqueuefixityTaskExecutionRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRole
          Condition: {}
          Effect: Allow
          Principal:
            Service: ecs-tasks.amazonaws.com
        Version: 2012-10-17
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
      - arn:aws:iam::aws:policy/AmazonSSMReadOnlyAccess
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: apt_queue_fixity
    Type: AWS::IAM::Role
  BagrestorerService:
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Ref: DefaultNetwork
          Subnets:
          - subnet-316bbe78
          - subnet-a53ee38b
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - BagrestorerServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: bag_restorer
      TaskDefinition:
        Ref: BagrestorerTaskDefinition
    Type: AWS::ECS::Service
  BagrestorerServiceDiscoveryEntry:
    Properties:
      Description: '"bag_restorer" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: bag_restorer
      NamespaceId:
        Ref: CloudMap
    Type: AWS::ServiceDiscovery::Service
  BagrestorerTaskDefinition:
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - preservation-services
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:1.0
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: Bagrestorer_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Bagrestorer_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/bag_restorer:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: bag_restorer
      Cpu: "256"
      ExecutionRoleArn: !GetAtt BagrestorerTaskExecutionRole.Arn
      TaskRoleArn: arn:aws:iam::997427182289:role/preserv-staging-poc-role
      Family: preservation-services-bag_restorer
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    Type: AWS::ECS::TaskDefinition
  BagrestorerTaskExecutionRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRole
          Condition: {}
          Effect: Allow
          Principal:
            Service: ecs-tasks.amazonaws.com
        Version: 2012-10-17
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
      - arn:aws:iam::aws:policy/AmazonSSMReadOnlyAccess
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: bag_restorer
    Type: AWS::IAM::Role
  
  
  FilerestorerService:
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Ref: DefaultNetwork
          Subnets:
          - subnet-316bbe78
          - subnet-a53ee38b
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - FilerestorerServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: file_restorer
      TaskDefinition:
        Ref: FilerestorerTaskDefinition
    Type: AWS::ECS::Service
  FilerestorerServiceDiscoveryEntry:
    Properties:
      Description: '"file_restorer" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: file_restorer
      NamespaceId:
        Ref: CloudMap
    Type: AWS::ServiceDiscovery::Service
  FilerestorerTaskDefinition:
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - preservation-services.local
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:1.0
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: Filerestorer_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Filerestorer_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/file_restorer:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: file_restorer
      Cpu: "256"
      ExecutionRoleArn: !GetAtt FilerestorerTaskExecutionRole.Arn
      TaskRoleArn: arn:aws:iam::997427182289:role/preserv-staging-poc-role
      Family: preservation-services-file_restorer
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    Type: AWS::ECS::TaskDefinition
  FilerestorerTaskExecutionRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRole
          Condition: {}
          Effect: Allow
          Principal:
            Service: ecs-tasks.amazonaws.com
        Version: 2012-10-17
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
      - arn:aws:iam::aws:policy/AmazonSSMReadOnlyAccess
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: file_restorer
    Type: AWS::IAM::Role
  GlacierrestorerService:
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Ref: DefaultNetwork
          Subnets:
          - subnet-316bbe78
          - subnet-a53ee38b
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - GlacierrestorerServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: glacier_restorer
      TaskDefinition:
        Ref: GlacierrestorerTaskDefinition
    Type: AWS::ECS::Service
  GlacierrestorerServiceDiscoveryEntry:
    Properties:
      Description: '"glacier_restorer" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: glacier_restorer
      NamespaceId:
        Ref: CloudMap
    Type: AWS::ServiceDiscovery::Service
  GlacierrestorerTaskDefinition:
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - preservation-services
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:1.0
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: Glacierrestorer_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Glacierrestorer_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/glacier_restorer:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: glacier_restorer
      Cpu: "256"
      ExecutionRoleArn: !GetAtt GlacierrestorerTaskExecutionRole.Arn
      TaskRoleArn: arn:aws:iam::997427182289:role/preserv-staging-poc-role
      Family: preservation-services-glacier_restorer
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    Type: AWS::ECS::TaskDefinition
  GlacierrestorerTaskExecutionRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRole
          Condition: {}
          Effect: Allow
          Principal:
            Service: ecs-tasks.amazonaws.com
        Version: 2012-10-17
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
      - arn:aws:iam::aws:policy/AmazonSSMReadOnlyAccess
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: glacier_restorer
    Type: AWS::IAM::Role
  IngestbucketreaderService:
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Ref: DefaultNetwork
          Subnets:
          - subnet-316bbe78
          - subnet-a53ee38b
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - IngestbucketreaderServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: ingest_bucket_reader
      TaskDefinition:
        Ref: IngestbucketreaderTaskDefinition
    Type: AWS::ECS::Service
  IngestbucketreaderServiceDiscoveryEntry:
    Properties:
      Description: '"ingest_bucket_reader" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: ingest_bucket_reader
      NamespaceId:
        Ref: CloudMap
    Type: AWS::ServiceDiscovery::Service
  IngestbucketreaderTaskDefinition:
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - preservation-services
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:1.0
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: Ingestbucketreader_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Ingestbucketreader_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/ingest_bucket_reader:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: ingest_bucket_reader
      Cpu: "256"
      ExecutionRoleArn: !GetAtt IngestbucketreaderTaskExecutionRole.Arn
      TaskRoleArn: arn:aws:iam::997427182289:role/preserv-staging-poc-role
      Family: preservation-services-ingest_bucket_reader
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    Type: AWS::ECS::TaskDefinition
  IngestbucketreaderTaskExecutionRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRole
          Condition: {}
          Effect: Allow
          Principal:
            Service: ecs-tasks.amazonaws.com
        Version: 2012-10-17
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
      - arn:aws:iam::aws:policy/AmazonSSMReadOnlyAccess
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: ingest_bucket_reader
    Type: AWS::IAM::Role
  IngestcleanupService:
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Ref: DefaultNetwork
          Subnets:
          - subnet-316bbe78
          - subnet-a53ee38b
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - IngestcleanupServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: ingest_cleanup
      TaskDefinition:
        Ref: IngestcleanupTaskDefinition
    Type: AWS::ECS::Service
  IngestcleanupServiceDiscoveryEntry:
    Properties:
      Description: '"ingest_cleanup" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: ingest_cleanup
      NamespaceId:
        Ref: CloudMap
    Type: AWS::ServiceDiscovery::Service
  IngestcleanupTaskDefinition:
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - preservation-services
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:1.0
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: Ingestcleanup_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Ingestcleanup_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/ingest_cleanup:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: ingest_cleanup
      Cpu: "256"
      ExecutionRoleArn: !GetAtt IngestcleanupTaskExecutionRole.Arn
      TaskRoleArn: arn:aws:iam::997427182289:role/preserv-staging-poc-role
      Family: preservation-services-ingest_cleanup
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    Type: AWS::ECS::TaskDefinition
  IngestcleanupTaskExecutionRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRole
          Condition: {}
          Effect: Allow
          Principal:
            Service: ecs-tasks.amazonaws.com
        Version: 2012-10-17
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
      - arn:aws:iam::aws:policy/AmazonSSMReadOnlyAccess
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: ingest_cleanup
    Type: AWS::IAM::Role
  erService:
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Ref: DefaultNetwork
          Subnets:
          - subnet-316bbe78
          - subnet-a53ee38b
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - erServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: ingest_format_identifier
      TaskDefinition:
        Ref: erTaskDefinition
    Type: AWS::ECS::Service
  erServiceDiscoveryEntry:
    Properties:
      Description: '"ingest_format_identifier" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: ingest_format_identifier
      NamespaceId:
        Ref: CloudMap
    Type: AWS::ServiceDiscovery::Service
  erTaskDefinition:
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - preservation-services
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:1.0
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: er_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: er_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/ingest_format_identifier:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: ingest_format_identifier
      Cpu: "256"
      ExecutionRoleArn: !GetAtt IngestformatidentifierTaskExecutionRole.Arn
      Family: preservation-services-ingest_format_identifier
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    Type: AWS::ECS::TaskDefinition
  IngestformatidentifierTaskExecutionRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRole
          Condition: {}
          Effect: Allow
          Principal:
            Service: ecs-tasks.amazonaws.com
        Version: 2012-10-17
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
      - arn:aws:iam::aws:policy/AmazonSSMReadOnlyAccess
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: ingest_format_identifier
    Type: AWS::IAM::Role
  IngestprefetchService:
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Ref: DefaultNetwork
          Subnets:
          - subnet-316bbe78
          - subnet-a53ee38b
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - IngestprefetchServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: ingest_pre_fetch
      TaskDefinition:
        Ref: IngestprefetchTaskDefinition
    Type: AWS::ECS::Service
  IngestprefetchServiceDiscoveryEntry:
    Properties:
      Description: '"ingest_pre_fetch" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: ingest_pre_fetch
      NamespaceId:
        Ref: CloudMap
    Type: AWS::ServiceDiscovery::Service
  IngestprefetchTaskDefinition:
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - preservation-services
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:1.0
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: Ingestprefetch_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Ingestprefetch_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/ingest_pre_fetch:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: ingest_pre_fetch
      Cpu: "256"
      ExecutionRoleArn: !GetAtt IngestprefetchTaskExecutionRole.Arn
      TaskRoleArn: arn:aws:iam::997427182289:role/preserv-staging-poc-role
      Family: preservation-services-ingest_pre_fetch
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    Type: AWS::ECS::TaskDefinition
  IngestprefetchTaskExecutionRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRole
          Condition: {}
          Effect: Allow
          Principal:
            Service: ecs-tasks.amazonaws.com
        Version: 2012-10-17
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
      - arn:aws:iam::aws:policy/AmazonSSMReadOnlyAccess
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: ingest_pre_fetch
    Type: AWS::IAM::Role
  IngestpreservationuploaderService:
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Ref: DefaultNetwork
          Subnets:
          - subnet-316bbe78
          - subnet-a53ee38b
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - IngestpreservationuploaderServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: ingest_preservation_uploader
      TaskDefinition:
        Ref: IngestpreservationuploaderTaskDefinition
    Type: AWS::ECS::Service
  IngestpreservationuploaderServiceDiscoveryEntry:
    Properties:
      Description: '"ingest_preservation_uploader" service discovery entry in Cloud
        Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: ingest_preservation_uploader
      NamespaceId:
        Ref: CloudMap
    Type: AWS::ServiceDiscovery::Service
  IngestpreservationuploaderTaskDefinition:
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - preservation-services
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:1.0
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: Ingestpreservationuploader_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Ingestpreservationuploader_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/ingest_preservation_uploader:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: ingest_preservation_uploader
      Cpu: "256"
      ExecutionRoleArn: !GetAtt IngestpreservationuploaderTaskExecutionRole.Arn
      TaskRoleArn: arn:aws:iam::997427182289:role/preserv-staging-poc-role
      Family: preservation-services-ingest_preservation_uploader
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    Type: AWS::ECS::TaskDefinition
  IngestpreservationuploaderTaskExecutionRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRole
          Condition: {}
          Effect: Allow
          Principal:
            Service: ecs-tasks.amazonaws.com
        Version: 2012-10-17
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
      - arn:aws:iam::aws:policy/AmazonSSMReadOnlyAccess
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: ingest_preservation_uploader
    Type: AWS::IAM::Role
  IngestpreservationverifierService:
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Ref: DefaultNetwork
          Subnets:
          - subnet-316bbe78
          - subnet-a53ee38b
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - IngestpreservationverifierServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: ingest_preservation_verifier
      TaskDefinition:
        Ref: IngestpreservationverifierTaskDefinition
    Type: AWS::ECS::Service
  IngestpreservationverifierServiceDiscoveryEntry:
    Properties:
      Description: '"ingest_preservation_verifier" service discovery entry in Cloud
        Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: ingest_preservation_verifier
      NamespaceId:
        Ref: CloudMap
    Type: AWS::ServiceDiscovery::Service
  IngestpreservationverifierTaskDefinition:
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - preservation-services
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:1.0
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: Ingestpreservationverifier_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Ingestpreservationverifier_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/ingest_preservation_verifier:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: ingest_preservation_verifier
      Cpu: "256"
      ExecutionRoleArn: !GetAtt IngestpreservationverifierTaskExecutionRole.Arn
      TaskRoleArn: arn:aws:iam::997427182289:role/preserv-staging-poc-role
      Family: preservation-services-ingest_preservation_verifier
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    Type: AWS::ECS::TaskDefinition
  IngestpreservationverifierTaskExecutionRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRole
          Condition: {}
          Effect: Allow
          Principal:
            Service: ecs-tasks.amazonaws.com
        Version: 2012-10-17
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
      - arn:aws:iam::aws:policy/AmazonSSMReadOnlyAccess
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: ingest_preservation_verifier
    Type: AWS::IAM::Role
  IngestrecorderService:
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Ref: DefaultNetwork
          Subnets:
          - subnet-316bbe78
          - subnet-a53ee38b
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - IngestrecorderServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: ingest_recorder
      TaskDefinition:
        Ref: IngestrecorderTaskDefinition
    Type: AWS::ECS::Service
  IngestrecorderServiceDiscoveryEntry:
    Properties:
      Description: '"ingest_recorder" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: ingest_recorder
      NamespaceId:
        Ref: CloudMap
    Type: AWS::ServiceDiscovery::Service
  IngestrecorderTaskDefinition:
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - preservation-services
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:1.0
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: Ingestrecorder_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Ingestrecorder_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/ingest_recorder:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: ingest_recorder
      Cpu: "256"
      ExecutionRoleArn: !GetAtt IngestrecorderTaskExecutionRole.Arn
      TaskRoleArn: arn:aws:iam::997427182289:role/preserv-staging-poc-role
      Family: preservation-services-ingest_recorder
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    Type: AWS::ECS::TaskDefinition
  IngestrecorderTaskExecutionRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRole
          Condition: {}
          Effect: Allow
          Principal:
            Service: ecs-tasks.amazonaws.com
        Version: 2012-10-17
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
      - arn:aws:iam::aws:policy/AmazonSSMReadOnlyAccess
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: ingest_recorder
    Type: AWS::IAM::Role
  IngeststaginguploaderService:
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Ref: DefaultNetwork
          Subnets:
          - subnet-316bbe78
          - subnet-a53ee38b
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - IngeststaginguploaderServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: ingest_staging_uploader
      TaskDefinition:
        Ref: IngeststaginguploaderTaskDefinition
    Type: AWS::ECS::Service
  IngeststaginguploaderServiceDiscoveryEntry:
    Properties:
      Description: '"ingest_staging_uploader" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: ingest_staging_uploader
      NamespaceId:
        Ref: CloudMap
    Type: AWS::ServiceDiscovery::Service
  IngeststaginguploaderTaskDefinition:
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - preservation-services
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:1.0
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: Ingeststaginguploader_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Ingeststaginguploader_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/ingest_staging_uploader:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: ingest_staging_uploader
      Cpu: "256"
      ExecutionRoleArn: !GetAtt IngeststaginguploaderTaskExecutionRole.Arn
      TaskRoleArn: arn:aws:iam::997427182289:role/preserv-staging-poc-role
      Family: preservation-services-ingest_staging_uploader
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    Type: AWS::ECS::TaskDefinition
  IngeststaginguploaderTaskExecutionRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRole
          Condition: {}
          Effect: Allow
          Principal:
            Service: ecs-tasks.amazonaws.com
        Version: 2012-10-17
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
      - arn:aws:iam::aws:policy/AmazonSSMReadOnlyAccess
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: ingest_staging_uploader
    Type: AWS::IAM::Role
  IngestvalidatorService:
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Ref: DefaultNetwork
          Subnets:
          - subnet-316bbe78
          - subnet-a53ee38b
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - IngestvalidatorServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: ingest_validator
      TaskDefinition:
        Ref: IngestvalidatorTaskDefinition
    Type: AWS::ECS::Service
  IngestvalidatorServiceDiscoveryEntry:
    Properties:
      Description: '"ingest_validator" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: ingest_validator
      NamespaceId:
        Ref: CloudMap
    Type: AWS::ServiceDiscovery::Service
  IngestvalidatorTaskDefinition:
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - preservation-services
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:1.0
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: Ingestvalidator_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Ingestvalidator_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/ingest_validator:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: ingest_validator
      Cpu: "256"
      ExecutionRoleArn: !GetAtt IngestvalidatorTaskExecutionRole.Arn
      TaskRoleArn: arn:aws:iam::997427182289:role/preserv-staging-poc-role
      Family: preservation-services-ingest_validator
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    Type: AWS::ECS::TaskDefinition
  IngestvalidatorTaskExecutionRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRole
          Condition: {}
          Effect: Allow
          Principal:
            Service: ecs-tasks.amazonaws.com
        Version: 2012-10-17
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
      - arn:aws:iam::aws:policy/AmazonSSMReadOnlyAccess
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: ingest_validator
    Type: AWS::IAM::Role
  
  ReingestmanagerService:
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Ref: DefaultNetwork
          Subnets:
          - subnet-316bbe78
          - subnet-a53ee38b
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - ReingestmanagerServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: reingest_manager
      TaskDefinition:
        Ref: ReingestmanagerTaskDefinition
    Type: AWS::ECS::Service
  ReingestmanagerServiceDiscoveryEntry:
    Properties:
      Description: '"reingest_manager" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: reingest_manager
      NamespaceId:
        Ref: CloudMap
    Type: AWS::ServiceDiscovery::Service
  ReingestmanagerTaskDefinition:
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - preservation-services
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:1.0
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: Reingestmanager_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Reingestmanager_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/reingest_manager:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: LogGroup
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: preservation-services
        Name: reingest_manager
      Cpu: "256"
      ExecutionRoleArn: !GetAtt ReingestmanagerTaskExecutionRole.Arn
      TaskRoleArn: arn:aws:iam::997427182289:role/preserv-staging-poc-role
      Family: preservation-services-reingest_manager
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    Type: AWS::ECS::TaskDefinition
  ReingestmanagerTaskExecutionRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRole
          Condition: {}
          Effect: Allow
          Principal:
            Service: ecs-tasks.amazonaws.com
        Version: 2012-10-17
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
      - arn:aws:iam::aws:policy/AmazonSSMReadOnlyAccess
      Tags:
      - Key: com.docker.compose.project
        Value: preservation-services
      - Key: com.docker.compose.service
        Value: reingest_manager
    Type: AWS::IAM::Role
