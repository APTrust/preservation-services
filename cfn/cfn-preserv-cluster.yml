AWSTemplateFormatVersion: 2010-09-09



Parameters:
  
  DNS:
    Description: Staging private Namespace
    Type: String
    Default: staging
  
  VPCID: 
    Description: Staging private Namespace
    Type: String
    Default: vpc-apt-staging
  
  ClusterName: 
    Description: The Name of the Fargate cluster hosting Preservation Services.
    Type: String
    Default: ecs-preserv-staging


Resources:

  PreservCapacityProviderAssociation:
    Type: AWS::ECS::ClusterCapacityProviderAssociations
    Properties: 
      CapacityProviders: 
        - FARGATE
        - FARGATE_SPOT 
      Cluster: !Ref Cluster
      DefaultCapacityProviderStrategy: 
        - CapacityProvider: FARGATE 
          Weight: 1
          Base: 1 
        - CapacityProvider: FARGATE_SPOT 
          Weight: 1 
          Base: 0
  
  Cluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Ref ClusterName
      ClusterSettings: 
        - Name: containerInsights
          Value: enabled 
      Configuration: 
        ExecuteCommandConfiguration: 
          Logging: DEFAULT 
      Tags:
      - Key: Name
        Value: !Sub 'ecs-preserv-${DNS}'
      - Key: Environment
        Value: !Ref DNS
      - Key: Service 
        Value: preserv

  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /ecs/preserv

  AptdeleteService: 
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA 
      ServiceName: ecs-delete
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - AptdeleteServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Service
        Value: preserv
      - Key: Environment
        Value: !Ref DNS
      TaskDefinition: !Ref AptdeleteTaskDefinition
    
  AptdeleteServiceDiscoveryEntry: 
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"aptdelete" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: delete
      NamespaceId: 
        Fn::ImportValue: !Sub "NameSpace-${DNS}"
    
  
  AptdeleteTaskDefinition: 
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref DNS
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Aptdelete_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Aptdelete_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/apt_delete:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: delete
        Name: delete
      Cpu: "256"
      ExecutionRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      TaskRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      Family: delete
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    
  AptfixityService: 
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED 
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceName: ecs-fixity
      ServiceRegistries:   
      - RegistryArn:
          Fn::GetAtt:
          - AptfixityServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Service
        Value: preserv
      - Key: Environment
        Value: !Ref "DNS"
      TaskDefinition: !Ref AptfixityTaskDefinition
    
  
  AptfixityServiceDiscoveryEntry: 
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"aptfixity" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: fixity
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"
    
  AptfixityTaskDefinition: 
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Aptfixity_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Aptfixity_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/apt_fixity:a5031e8-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: fixity
        Name: fixity
      Cpu: "256"
      ExecutionRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      TaskRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      Family: preservation-services-apt_fixity
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    
  
  AptqueueService: 
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE 
      SchedulingStrategy: REPLICA
      ServiceName: ecs-queue
      ServiceRegistries:   
      - RegistryArn:
          Fn::GetAtt:
          - AptqueueServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Service
        Value: preserv
      - Key: Environment
        Value: !Ref "DNS"
      TaskDefinition: !Ref AptqueueTaskDefinition
  
  AptqueueServiceDiscoveryEntry: 
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"aptqueue" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: queue
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"
    
  
  AptqueueTaskDefinition: 
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Aptqueue_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Aptqueue_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/apt_queue:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: queue
        Name: queue
      Cpu: "256"
      ExecutionRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      TaskRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      Family: preservation-services-apt_queue
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
  
  AptqueuefixityService: 
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy:  REPLICA
      ServiceName: ecs-queuefixity
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - AptqueuefixityServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref AptqueuefixityTaskDefinition
    
  AptqueuefixityServiceDiscoveryEntry: 
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"aptqueuefixity" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: queuefixity
      NamespaceId: 
        Fn::ImportValue: !Sub "NameSpace-${DNS}"
    
  
  AptqueuefixityTaskDefinition: 
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Aptqueuefixity_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Aptqueuefixity_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/apt_queue_fixity:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: aptqueuefixity
        Name: queuefixity
      Cpu: "256"
      ExecutionRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      Family: preservation-services-apt_queue_fixity
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    
  BagrestorerService: 
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA 
      ServiceName: ecs-bagrestorer
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - BagrestorerServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref BagrestorerTaskDefinition
    
  BagrestorerServiceDiscoveryEntry: 
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"bagrestorer" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: bagrestorer
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"
    
  BagrestorerTaskDefinition: 
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Bagrestorer_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Bagrestorer_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/bag_restorer:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: bagrestorer
        Name: bagrestorer
      Cpu: "256"
      ExecutionRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      TaskRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      Family: preservation-services-bag_restorer
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
  
  
  FilerestorerService: 
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA 
      ServiceName: ecs-filerestorer
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - FilerestorerServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref FilerestorerTaskDefinition
    
  FilerestorerServiceDiscoveryEntry: 
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"filerestorer" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: filerestorer
      NamespaceId: 
        Fn::ImportValue: !Sub "NameSpace-${DNS}"
    
  FilerestorerTaskDefinition: 
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref: AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Filerestorer_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Filerestorer_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/file_restorer:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: filerestorer
        Name: filerestorer
      Cpu: "256"
      ExecutionRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      TaskRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      Family: preservation-services-file_restorer
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    
  GlacierrestorerService: 
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA 
      ServiceName: ecs-glacierrestorer
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - GlacierrestorerServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref GlacierrestorerTaskDefinition
    
  GlacierrestorerServiceDiscoveryEntry: 
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"glacierrestorer" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: glacierrestorer
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"
    
  
  GlacierrestorerTaskDefinition: 
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Glacierrestorer_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Glacierrestorer_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/glacier_restorer:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: glacierrestorer
        Name: glacierrestorer
      Cpu: "256"
      ExecutionRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      TaskRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      Family: preservation-services-glacier_restorer
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    
  IngestbucketreaderService: 
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceName: ecs-ingestbucketreader
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - IngestbucketreaderServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment 
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref IngestbucketreaderTaskDefinition
    
  IngestbucketreaderServiceDiscoveryEntry: 
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"ingestbucketreader" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: ingestbucketreader
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"
    
  IngestbucketreaderTaskDefinition:
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:sidecar
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Ingestbucketreader_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Ingestbucketreader_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/ingest_bucket_reader:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: ingestbucketreader
        Name: ingestbucketreader
      Cpu: "256"
      ExecutionRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      TaskRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      Family: preservation-services-ingest_bucket_reader
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    Type: AWS::ECS::TaskDefinition
  
  IngestcleanupService: 
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA 
      ServiceName: ecs-ingestcleanup
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - IngestcleanupServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition:
        Ref: IngestcleanupTaskDefinition
    
  IngestcleanupServiceDiscoveryEntry: 
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"ingestcleanup" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: ingestcleanup
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"
    
  
  IngestcleanupTaskDefinition: 
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Ingestcleanup_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Ingestcleanup_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/ingest_cleanup:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: ingestcleanup
        Name: ingestcleanup
      Cpu: "256"
      ExecutionRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      TaskRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      Family: preservation-services-ingest_cleanup
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    
  
  erService: 
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceName: ecs-formatidentifier
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - erServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref erTaskDefinition
    
  
  erServiceDiscoveryEntry: 
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"ingest_format_identifier" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: ingest_format_identifier
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"
    
  
  erTaskDefinition: 
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: er_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: er_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/ingest_format_identifier:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: ingestformatidentifier
        Name: ingest_format_identifier
      Cpu: "256"
      ExecutionRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      Family: preservation-services-ingest_format_identifier
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    
  
  IngestprefetchService: 
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA 
      ServiceName: ecs-ingestprefetch
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - IngestprefetchServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref IngestprefetchTaskDefinition
    
  
  IngestprefetchServiceDiscoveryEntry: 
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"ingestprefetch" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: ingestprefetch
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"
    
  
  IngestprefetchTaskDefinition: 
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Ingestprefetch_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Ingestprefetch_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/ingest_pre_fetch:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: ingestprefetch
        Name: ingest_pre_fetch
      Cpu: "256"
      ExecutionRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      TaskRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      Family: preservation-services-ingest_pre_fetch
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    
  
  
  IngestpreservationuploaderService: 
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA 
      ServiceName: ecs-ingestuploader
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - IngestpreservationuploaderServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref IngestpreservationuploaderTaskDefinition
    
  
  IngestpreservationuploaderServiceDiscoveryEntry: 
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"ingestpreservationuploader" service discovery entry in Cloud
        Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: ingestuploader
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"
    
  
  IngestpreservationuploaderTaskDefinition: 
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Ingestpreservationuploader_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Ingestpreservationuploader_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/ingest_preservation_uploader:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: ingestpreservuploader
        Name: ingest_preservation_uploader
      Cpu: "256"
      ExecutionRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      TaskRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      Family: preservation-services-ingest_preservation_uploader
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
  
  IngestpreservationverifierService: 
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - IngestpreservationverifierServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref IngestpreservationverifierTaskDefinition
    
  
  IngestpreservationverifierServiceDiscoveryEntry: 
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"ingestpreservationverifier" service discovery entry in Cloud
        Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: ingestpreservationverifier
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"
    
  
  IngestpreservationverifierTaskDefinition: 
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Ingestpreservationverifier_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Ingestpreservationverifier_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/ingest_preservation_verifier:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: ingestpreservvarifier
        Name: ingest_preservation_verifier
      Cpu: "256"
      ExecutionRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      TaskRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      Family: preservation-services-ingest_preservation_verifier
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    

  
  IngestrecorderService: 
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA 
      ServiceName: ecs-ingestrecorder
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - IngestrecorderServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref IngestrecorderTaskDefinition
    
  
  IngestrecorderServiceDiscoveryEntry: 
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"ingestrecorder" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: ingestrecorder
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"
    
  
  IngestrecorderTaskDefinition: 
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Ingestrecorder_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Ingestrecorder_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/ingest_recorder:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: ingestrecorder
        Name: ingestrecorder
      Cpu: "256"
      ExecutionRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      TaskRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      Family: preservation-services-ingest_recorder
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    
  
  
  IngeststaginguploaderService: 
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA 
      ServiceName: ecs-staginguploader
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - IngeststaginguploaderServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref IngeststaginguploaderTaskDefinition
    
  
  IngeststaginguploaderServiceDiscoveryEntry: 
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"ingeststaginguploader" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: staginguploader
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"
    
  
  IngeststaginguploaderTaskDefinition: 
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar 
        Name: Ingeststaginguploader_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Ingeststaginguploader_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/ingest_staging_uploader:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: ingeststaginguploader
        Name: staginguploader
      Cpu: "256"
      ExecutionRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      TaskRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      Family: preservation-services-ingest_staging_uploader
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    
  
  
  IngestvalidatorService: 
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA 
      ServiceName: ecs-ingestvalidator
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - IngestvalidatorServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref IngestvalidatorTaskDefinition
  
  IngestvalidatorServiceDiscoveryEntry: 
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"ingestvalidator" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: ingestvalidator
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"
      
  IngestvalidatorTaskDefinition: 
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Ingestvalidator_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Ingestvalidator_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/ingest_validator:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: ingestvalidator
        Name: ingestvalidator
      Cpu: "256"
      ExecutionRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      TaskRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      Family: preservation-services-ingest_validator
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    
  
  ReingestmanagerService: 
    Type: AWS::ECS::Service
    Properties:
      Cluster:
        Fn::GetAtt:
        - Cluster
        - Arn
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
          - Fn::ImportValue: !Sub "PreservSecurityGroup-${DNS}"
          - Fn::ImportValue: !Sub "UnifiedSecurityGroup-${DNS}"
          Subnets:
          - Fn::ImportValue: !Sub "PrivateSubnet0-${DNS}"
          - Fn::ImportValue: !Sub "PrivateSubnet1-${DNS}"
      PlatformVersion: 1.4.0
      PropagateTags: SERVICE
      SchedulingStrategy: REPLICA 
      ServiceName: ecs-reingestmanager
      ServiceRegistries:
      - RegistryArn:
          Fn::GetAtt:
          - ReingestmanagerServiceDiscoveryEntry
          - Arn
      Tags:
      - Key: Environment
        Value: !Ref "DNS"
      - Key: Service
        Value: preserv
      TaskDefinition: !Ref ReingestmanagerTaskDefinition
    
  
  ReingestmanagerServiceDiscoveryEntry: 
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Description: '"reingestmanager" service discovery entry in Cloud Map'
      DnsConfig:
        DnsRecords:
        - TTL: 60
          Type: A
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1
      Name: reingestmanager
      NamespaceId:
        Fn::ImportValue: !Sub "NameSpace-${DNS}"
    
  
  ReingestmanagerTaskDefinition: 
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
      - Command:
        - us-east-1.compute.internal
        - !Ref "DNS"
        Essential: false
        Image: docker/ecs-searchdomain-sidecar:latest
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: sidecar
        Name: Reingestmanager_ResolvConf_InitContainer
      - DependsOn:
        - Condition: SUCCESS
          ContainerName: Reingestmanager_ResolvConf_InitContainer
        Secrets:
        - Name: MAX_DAYS_SINCE_LAST_FIXITY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/MAX_DAYS_SINCE_LAST_FIXITY
        - Name: LOG_DIR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/LOG_DIR
        - Name: APT_DELETE_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_BUFFER_SIZE
        - Name: APT_DELETE_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_DELETE_WORKERS
        - Name: APT_FIXITY_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_BUFFER_SIZE
        - Name: APT_FIXITY_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/APT_FIXITY_WORKERS
        - Name: FILE_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_BUFFER_SIZE
        - Name: FILE_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/FILE_RESTORER_WORKERS
        - Name: GLACIER_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_BUFFER_SIZE
        - Name: GLACIER_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/GLACIER_RESTORER_WORKERS
        - Name: INGEST_CLEANUP_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_BUFFER_SIZE
        - Name: INGEST_CLEANUP_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_CLEANUP_WORKERS
        - Name: INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_BUFFER_SIZE
        - Name: INGEST_FORMAT_IDENTIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_FORMAT_IDENTIFIER_WORKERS
        - Name: INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_UPLOADER_WORKERS
        - Name: INGEST_PRE_FETCH_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_BUFFER_SIZE
        - Name: INGEST_PRE_FETCH_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRE_FETCH_WORKERS
        - Name: INGEST_STAGING_UPLOADER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_BUFFER_SIZE
        - Name: INGEST_STAGING_UPLOADER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_STAGING_UPLOADER_WORKERS
        - Name: INGEST_VALIDATOR_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_BUFFER_SIZE
        - Name: INGEST_VALIDATOR_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_VALIDATOR_WORKERS
        - Name: INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_BUFFER_SIZE
        - Name: INGEST_PRESERVATION_VERIFIER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_PRESERVATION_VERIFIER_WORKERS
        - Name: BAG_RESTORER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_BUFFER_SIZE
        - Name: BAG_RESTORER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BAG_RESTORER_WORKERS
        - Name: REINGEST_MANAGER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_BUFFER_SIZE
        - Name: REINGEST_MANAGER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REINGEST_MANAGER_WORKERS
        - Name: INGEST_RECORDER_BUFFER_SIZE
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_BUFFER_SIZE
        - Name: INGEST_RECORDER_WORKERS
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/INGEST_RECORDER_WORKERS
        - Name: BUCKET_GLACIER_DEEP_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OH
        - Name: BUCKET_GLACIER_DEEP_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_OR
        - Name: BUCKET_GLACIER_DEEP_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_DEEP_VA
        - Name: BUCKET_GLACIER_OH
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OH
        - Name: BUCKET_GLACIER_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_OR
        - Name: BUCKET_GLACIER_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_GLACIER_VA
        - Name: BUCKET_STANDARD_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_OR
        - Name: BUCKET_STANDARD_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_STANDARD_VA
        - Name: BUCKET_WASABI_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_OR
        - Name: BUCKET_WASABI_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/BUCKET_WASABI_VA
        - Name: NSQ_LOOKUPD
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_LOOKUP
        - Name: NSQ_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/NSQ_URL
        - Name: PRESERV_REGISTRY_API_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_KEY
        - Name: PRESERV_REGISTRY_API_USER
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_API_USER
        - Name: PRESERV_REGISTRY_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/PRESERV_REGISTRY_URL
        - Name: REDIS_URL
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/REDIS_URL
        - Name: S3_AWS_HOST
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_HOST
        - Name: S3_AWS_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_KEY
        - Name: S3_AWS_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_AWS_SECRET
        - Name: S3_WASABI_HOST_OR
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_OR
        - Name: S3_WASABI_HOST_VA
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_HOST_VA
        - Name: S3_WASABI_KEY
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_KEY
        - Name: S3_WASABI_SECRET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/S3_WASABI_SECRET
        - Name: STAGING_BUCKET
          ValueFrom: arn:aws:ssm:us-east-1:997427182289:parameter/STAGING/PRESERV/STAGING_BUCKET
        Essential: true
        StopTimeout: 120
        Image: docker.io/aptrust/reingest_manager:9d8b9c2-master
        LinuxParameters: {}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: reingestmanager
        Name: reingestmanager
      Cpu: "256"
      ExecutionRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      TaskRoleArn: 
        Fn::ImportValue: !Sub "NSQTaskRole-${DNS}"
      Family: preservation-services-reingest_manager
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
    
  
  
